name: Daily Content Generator

on:
  # Her gÃ¼n UTC 07:00'da Ã§alÄ±ÅŸ (TR saat 10:00)
  schedule:
    - cron: '0 7 * * *'
  
  # Manuel tetikleme
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  generate-daily-post:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ¤– Generate daily content
        env:
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
          GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
          GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
          GEMINI_API_KEY_7: ${{ secrets.GEMINI_API_KEY_7 }}
          GEMINI_API_KEY_8: ${{ secrets.GEMINI_API_KEY_8 }}
          GEMINI_API_KEY_9: ${{ secrets.GEMINI_API_KEY_9 }}
          GEMINI_API_KEY_10: ${{ secrets.GEMINI_API_KEY_10 }}
        run: node scripts/content-manager.js

      - name: ðŸ“Š Check for changes
        id: git-check
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "New content generated!"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No new content (already posted today or error)"
          fi

      - name: ðŸ“¤ Commit and push
        if: steps.git-check.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "PromptMaster Bot"
          git config user.email "bot@promptmaster.ai"
          
          # Configure git with token for push
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          git add posts/ data/ || true
          git commit -m "ðŸ“ Daily post: $(date +%Y-%m-%d) [skip ci]"
          git push origin main

      - name: ðŸ“ˆ Summary
        run: |
          echo "### ðŸ¤– Daily Content Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.git-check.outputs.changes }}" == "true" ]; then
            echo "âœ… New blog post generated and published!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the posts/ directory for the new content." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No new post today (already published or skipped)" >> $GITHUB_STEP_SUMMARY
          fi

