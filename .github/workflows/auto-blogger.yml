name: Auto Blog Generator

on:
  # Her 2 gÃ¼nde bir UTC 08:00'da Ã§alÄ±ÅŸ
  schedule:
    - cron: '0 8 */2 * *'
  
  # Manuel tetikleme (test iÃ§in)
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if no pending topics'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'

jobs:
  generate-post:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ¤– Generate blog post
        env:
          # 10 API Key Rotation
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3: ${{ secrets.GEMINI_API_KEY_3 }}
          GEMINI_API_KEY_4: ${{ secrets.GEMINI_API_KEY_4 }}
          GEMINI_API_KEY_5: ${{ secrets.GEMINI_API_KEY_5 }}
          GEMINI_API_KEY_6: ${{ secrets.GEMINI_API_KEY_6 }}
          GEMINI_API_KEY_7: ${{ secrets.GEMINI_API_KEY_7 }}
          GEMINI_API_KEY_8: ${{ secrets.GEMINI_API_KEY_8 }}
          GEMINI_API_KEY_9: ${{ secrets.GEMINI_API_KEY_9 }}
          GEMINI_API_KEY_10: ${{ secrets.GEMINI_API_KEY_10 }}
        run: node scripts/generate-post.js

      - name: ðŸ“Š Check for changes
        id: git-check
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Commit and push
        if: steps.git-check.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Auto Blogger Bot"
          git config user.email "bot@promptmaster.ai"
          
          # Configure git with token for push
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          git add posts/ data/content-planner.json || true
          git commit -m "ðŸ“ Auto-generated blog post [skip ci]"
          git push origin main

      - name: ðŸ”” Summary
        run: |
          echo "### ðŸ¤– Auto-Blogger Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.git-check.outputs.changes }}" == "true" ]; then
            echo "âœ… New blog post generated and published!" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No new posts to generate (all topics published)" >> $GITHUB_STEP_SUMMARY
          fi
